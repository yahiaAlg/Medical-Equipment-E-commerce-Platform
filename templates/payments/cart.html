{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Fennec Med{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<!-- Cart Header -->
<div class="cart-header">
  <div class="cart-header-content">
    <h1>Shopping Cart</h1>
    <p>Review your medical supplies and equipment</p>
  </div>
</div>

<!-- Cart Content -->
<div class="cart-section">
  <div class="cart-container">
    <div class="cart-items">
      {% if cart_items %}
        {% for item in cart_items %}
        <div class="cart-item">
          <div class="item-image">
            <img
              src="{% if item.product.image %}{{ item.product.image.url }}{% else %}{% static 'images/product-placeholder.jpg' %}{% endif %}"
              alt="{{ item.product.name }}"
            />
          </div>
          <div class="item-details">
            <h3>{{ item.product.name }}</h3>
            <p class="item-category">{{ item.product.get_category_display|default:"Medical Equipment" }}</p>
            <p class="item-description">
              {{ item.product.short_description|default:item.product.description|truncatewords:15 }}
            </p>
          </div>
          <div class="item-quantity">
            <button class="qty-btn minus" onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'-1' }})"
                    {% if item.quantity <= 1 %}disabled{% endif %}>-</button>
            <input type="number" value="{{ item.quantity }}" min="1" max="{{ item.product.stock_quantity }}" 
                   class="qty-input" onchange="updateQuantity({{ item.id }}, this.value)" />
            <button class="qty-btn plus" onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'1' }})"
                    {% if item.quantity >= item.product.stock_quantity %}disabled{% endif %}>+</button>
          </div>
          <div class="item-price">
            <span class="price">
              {% if item.quantity >= item.product.bulk_quantity and item.product.bulk_price %}
                ${{ item.product.bulk_price|floatformat:2 }}
              {% else %}
                ${{ item.product.price|floatformat:2 }}
              {% endif %}
            </span>
          </div>
          <div class="item-actions">
            <button class="remove-btn" onclick="removeItem({{ item.id }})">Remove</button>
            <button class="save-btn" onclick="saveForLater({{ item.id }})">Save for Later</button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; padding: 3rem;">
          <p style="font-size: 1.2rem; color: #666;">Your cart is empty</p>
          <a href="{% url 'products:list' %}" class="btn btn-call" style="margin-top: 1rem;">Start Shopping</a>
        </div>
      {% endif %}
    </div>

    {% if cart_items %}
    <div class="cart-summary">
      <div class="summary-card">
        <h3>Order Summary</h3>
        <div class="summary-row">
          <span>Subtotal ({{ cart.get_total_items }} item{{ cart.get_total_items|pluralize }})</span>
          <span>${{ cart.get_total_price|floatformat:2 }}</span>
        </div>
        <div class="summary-row">
          <span>Shipping</span>
          <span>{% if cart.get_total_price >= 500 %}FREE{% else %}$9.99{% endif %}</span>
        </div>
        <div class="summary-row">
          <span>Tax</span>
          <span>${{ cart.get_total_price|floatformat:2|add:"*0.08"|floatformat:2 }}</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-row total">
          <span>Total</span>
          <span>
            {% widthratio cart.get_total_price 1 1.08 as total_with_tax %}
            {% if cart.get_total_price >= 500 %}
              ${{ total_with_tax|floatformat:2 }}
            {% else %}
              ${{ total_with_tax|add:9.99|floatformat:2 }}
            {% endif %}
          </span>
        </div>
        <button class="checkout-btn" onclick="location.href='{% url 'payments:checkout' %}'">
          Proceed to Checkout
        </button>
        <button class="continue-shopping-btn" onclick="location.href='{% url 'products:list' %}'">
          Continue Shopping
        </button>
      </div>

      <div class="promo-card">
        <h4>Have a Promo Code?</h4>
        <form method="post" action="#" class="promo-input-group">
          {% csrf_token %}
          <input
            type="text"
            name="promo_code"
            placeholder="Enter promo code"
            class="promo-input"
          />
          <button type="submit" class="apply-btn">Apply</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    fetch('{% url "payments:update_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({
            cart_item_id: itemId,
            quantity: parseInt(newQuantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating cart: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the cart');
    });
}

function removeItem(itemId) {
    if (confirm('Remove this item from your cart?')) {
        location.href = '{% url "payments:remove_from_cart" 0 %}'.replace('0', itemId);
    }
}

function saveForLater(itemId) {
    fetch('#', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ cart_item_id: itemId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}
</script>
{% endblock %}