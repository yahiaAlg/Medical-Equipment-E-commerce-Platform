{% extends 'base.html' %}
{% load static %}

{% block title %}Panier - Fennec Med{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<!-- Cart Header -->
<div class="cart-header">
  <div class="cart-header-content">
    <h1>Panier</h1>
    <p>Vérifiez vos fournitures et équipements médicaux</p>
  </div>
</div>

<!-- Cart Content -->
<div class="cart-section">
  <div class="cart-container">
    <div class="cart-items">
      {% if cart_items %}
        {% for item in cart_items %}
          <div class="cart-item">
            <div class="item-image">
              <a href="{{ item.product.get_absolute_url }}">
                <img
                  src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% else %}{% static 'images/placeholder.png' %}{% endif %}"
                  alt="{{ item.product.name }}"
                />
              </a>
            </div>
            <div class="item-details">
              <a href="{{ item.product.get_absolute_url }}" style="text-decoration: none;">
                <h3>{{ item.product.name }}</h3>
              </a>
              <p class="item-category">{{ item.product.category.name }}</p>
              {% if item.variant %}
              <p class="item-variant">
                <strong>{{ item.variant.variant_title }} :</strong> {{ item.variant.variant_value }}
              </p>
              {% endif %}
              <p class="item-description">
                {{ item.product.short_description|truncatewords:15 }}
              </p>
            </div>
            <div class="item-quantity">
              <button class="qty-btn minus" onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'-1' }})"
                      {% if item.quantity <= 1 %}disabled{% endif %}>-</button>
              <input type="number" value="{{ item.quantity }}" min="1" 
                    max="{% if item.variant %}{{ item.variant.stock_quantity }}{% else %}{{ item.product.stock_quantity }}{% endif %}" 
                    class="qty-input" readonly />
              <button class="qty-btn plus" onclick="updateQuantity({{ item.id }}, {{ item.quantity|add:'1' }})"
                      {% if item.variant %}
                        {% if item.quantity >= item.variant.stock_quantity %}disabled{% endif %}
                      {% else %}
                        {% if item.quantity >= item.product.stock_quantity %}disabled{% endif %}
                      {% endif %}>+</button>
            </div>
            <div class="item-price">
              <span class="price">{{ item.get_unit_price|floatformat:2 }} DZD</span>
              <span class="item-subtotal">{{ item.get_total_price|floatformat:2 }} DZD</span>
            </div>
            <div class="item-actions">
              <button class="remove-btn" onclick="removeItem({{ item.id }})">
                <i class="fas fa-trash"></i> Supprimer
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; padding: 3rem;">
          <p style="font-size: 1.2rem; color: #666;">Votre panier est vide</p>
          <a href="{% url 'products:list' %}" class="btn btn-call" style="margin-top: 1rem;">Commencer vos achats</a>
        </div>
      {% endif %}
    </div>

    {% if cart_items %}
    <div class="cart-summary">
      <div class="summary-card">
        <h3>Récapitulatif de la commande</h3>
        <div class="summary-row">
          <span>Sous-total ({{ cart.get_total_items }} article{{ cart.get_total_items|pluralize }})</span>
          <span>{{ cart.get_total_price|floatformat:2 }} DZD</span>
        </div>

        <div class="summary-row">
          <span>Taxe ({% widthratio tva_rate 1 100 as tax_percentage %}{{ tax_percentage|floatformat:0 }}%)</span>
          <span>{{ tax_amount|floatformat:2 }} DZD</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-row total">
          <span>Total</span>
          <span>{{ cart_total|floatformat:2 }} DZD</span>
        </div>

        <button class="checkout-btn" onclick="location.href='{% url 'payments:checkout' %}'">
          Procéder au paiement
        </button>
        <button class="continue-shopping-btn" onclick="location.href='{% url 'products:list' %}'">
          Continuer vos achats
        </button>
      </div>

      <div class="promo-card">
        <h4>Vous avez un code promo ?</h4>
        <form method="post" action="#" class="promo-input-group">
          {% csrf_token %}
          <input
            type="text"
            name="promo_code"
            placeholder="Entrez le code promo"
            class="promo-input"
          />
          <button type="submit" class="apply-btn">Appliquer</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;
    
    fetch('{% url "payments:update_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({
            cart_item_id: itemId,
            quantity: parseInt(newQuantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur lors de la mise à jour du panier : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur s\'est produite lors de la mise à jour du panier');
    });
}

function removeItem(itemId) {
    if (confirm('Retirer cet article de votre panier ?')) {
        location.href = '{% url "payments:remove_from_cart" 0 %}'.replace('0', itemId);
    }
}

function saveForLater(itemId) {
    fetch('#', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ cart_item_id: itemId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erreur : ' + data.message);
        }
    });
}
</script>
{% endblock %}