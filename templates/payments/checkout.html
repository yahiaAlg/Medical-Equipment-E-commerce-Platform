{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Fennec Med{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkOut.css' %}">
<style>
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
  }
  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  .checkbox-label {
    margin: 0;
    cursor: pointer;
    user-select: none;
  }
</style>
{% endblock %}

{% block content %}
<!-- Checkout Header -->
<div class="checkout-header">
  <div class="checkout-header-content">
    <h1>Secure Checkout</h1>
    <div class="checkout-steps">
      <div class="step active">
        <span class="step-number">1</span>
        <span class="step-text">Shipping</span>
      </div>
      <div class="step">
        <span class="step-number">2</span>
        <span class="step-text">Review</span>
      </div>
      <div class="step">
        <span class="step-number">3</span>
        <span class="step-text">Payment</span>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Content -->
<div class="checkout-section">
  <div class="checkout-container">
    <form method="post" enctype="multipart/form-data" class="checkout-form" id="checkout-form">
      {% csrf_token %}
      
      <div class="form-section">
        <h2>Shipping Information</h2>
        <div class="shipping-form">
          {% if form.non_field_errors %}
            <div class="alert alert-error">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <div class="form-group">
            <label for="{{ form.shipping_address.id_for_label }}">{{ form.shipping_address.label }} *</label>
            {{ form.shipping_address }}
            {% if form.shipping_address.errors %}
              <div class="error-message">{{ form.shipping_address.errors }}</div>
            {% endif %}
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.shipping_city.id_for_label }}">{{ form.shipping_city.label }} *</label>
              {{ form.shipping_city }}
              {% if form.shipping_city.errors %}
                <div class="error-message">{{ form.shipping_city.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label for="{{ form.shipping_state.id_for_label }}">{{ form.shipping_state.label }} *</label>
              {{ form.shipping_state }}
              {% if form.shipping_state.errors %}
                <div class="error-message">{{ form.shipping_state.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label for="{{ form.shipping_zip.id_for_label }}">{{ form.shipping_zip.label }} *</label>
              {{ form.shipping_zip }}
              {% if form.shipping_zip.errors %}
                <div class="error-message">{{ form.shipping_zip.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="checkbox-group">
            {{ form.billing_same }}
            <label for="{{ form.billing_same.id_for_label }}" class="checkbox-label">
              {{ form.billing_same.label }}
            </label>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h2>Shipping Method</h2>
        <div class="shipping-options">
          {% for shipping_type in shipping_types %}
          <div class="shipping-option">
            <label class="shipping-option-content">
              <input type="radio" name="shipping_type" value="{{ shipping_type.id }}" 
                    {% if forloop.first %}checked{% endif %}
                    data-cost="{{ shipping_type.cost }}"
                    data-days="{{ shipping_type.estimated_days }}"
                    class="shipping-radio">
              <div class="option-info">
                <span class="option-name">{{ shipping_type.name }}</span>
                <span class="option-time">{{ shipping_type.estimated_days }} business days</span>
                {% if shipping_type.description %}
                <span class="option-desc">{{ shipping_type.description }}</span>
                {% endif %}
              </div>
              <span class="option-price">{{ shipping_type.cost }} DZD</span>
            </label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="form-section">
        <h2>Order Notes &amp; Attachments</h2>
        <div class="form-group">
          <label for="{{ form.order_note.id_for_label }}">{{ form.order_note.label }}</label>
          {{ form.order_note }}
          <small class="text-muted">Add any special instructions or requirements for this order</small>
        </div>
        
        <div class="form-group mt-3">
          <label for="note_attachments">Attachments (Optional)</label>
          <input type="file" name="note_attachments" id="note_attachments" 
                class="form-control" multiple
                accept="image/*,application/pdf,.doc,.docx">
          <small class="text-muted">Upload prescriptions, medical reports, or other relevant documents (max 10MB each)</small>
        </div>
      </div>

      <div class="form-section">
        <h2>Payment Information</h2>
        <div class="payment-info-box">
          <div class="payment-info-header">
            <svg class="payment-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <h3>Payment After Order Placement</h3>
          </div>
          <p>After placing your order, you'll receive an invoice with detailed payment instructions.</p>
          
          <div class="payment-methods-list">
            <h4>Accepted Payment Methods:</h4>
            <ul>
              <li>
                <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                BaridiMob
              </li>
              <li>
                <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                CCP Cheque
              </li>
              <li>
                <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Bank Transfer
              </li>
              <li>
                <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Cash Deposit
              </li>
            </ul>
          </div>
          
          <div class="payment-note">
            <svg class="note-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            You'll upload payment proof after completing the payment
          </div>
        </div>
      </div>
    </form>

    <div class="order-summary">
      <div class="summary-card">
        <h3>Order Summary</h3>

        <div class="order-items">
          {% for item in cart.items.all %}
          <div class="order-item">
            <img src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% else %}{% static 'images/product-placeholder.jpg' %}{% endif %}"
                 alt="{{ item.product.name }}" />
            <div class="item-details">
              <h4>{{ item.product.name }}</h4>
              <p>Qty: {{ item.quantity }}</p>
            </div>
            <span class="item-price">{{ item.get_total_price|floatformat:2 }} DZD</span>
          </div>
          {% empty %}
          <div class="empty-cart">
            <p>Your cart is empty.</p>
          </div>
          {% endfor %}
        </div>

        <div class="summary-calculations">
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal" data-value="{{ cart.get_total_price }}">{{ cart.get_total_price|floatformat:2 }} DZD</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping-cost" data-value="{% if shipping_types.first %}{{ shipping_types.first.cost }}{% else %}500.00{% endif %}">
              {% if shipping_types.first %}{{ shipping_types.first.cost|floatformat:2 }}{% else %}500.00{% endif %} DZD
            </span>
          </div>
          <div class="summary-row">
            <span>Tax (19%)</span>
            <span id="tax" data-rate="0.19"></span>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total-amount"></span>
          </div>
        </div>

        <button type="submit" form="checkout-form" class="place-order-btn">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          Place Order
        </button>

        <div class="security-info">
          <svg class="lock-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          Your order information is secure
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calculate and update totals
function updateTotals() {
    const subtotalEl = document.getElementById('subtotal');
    const shippingEl = document.getElementById('shipping-cost');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total-amount');
    
    const subtotal = parseFloat(subtotalEl.dataset.value || 0);
    const shipping = parseFloat(shippingEl.dataset.value || 0);
    const taxRate = parseFloat(taxEl.dataset.rate || 0);
    
    const tax = subtotal * taxRate;
    const total = subtotal + shipping + tax;
    
    taxEl.textContent = tax.toFixed(2) + ' DZD';
    totalEl.textContent = total.toFixed(2) + ' DZD';
}

// Update shipping cost when selection changes
document.querySelectorAll('.shipping-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        const shippingEl = document.getElementById('shipping-cost');
        const cost = parseFloat(this.dataset.cost || 0);
        shippingEl.dataset.value = cost;
        shippingEl.textContent = cost.toFixed(2) + ' DZD';
        updateTotals();
    });
});

// Initial calculation
updateTotals();

// Form validation
document.querySelector('.checkout-form').addEventListener('submit', function(e) {
    const form = this;
    let isValid = true;
    
    // Check all required fields
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('error');
        } else {
            field.classList.remove('error');
        }
    });
    
    // Check shipping type is selected
    const shippingSelected = form.querySelector('input[name="shipping_type"]:checked');
    if (!shippingSelected) {
        isValid = false;
        alert('Please select a shipping method');
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields');
    }
});

// Remove error styling on input
document.querySelectorAll('input, textarea, select').forEach(field => {
    field.addEventListener('input', function() {
        this.classList.remove('error');
    });
});
</script>
{% endblock %}