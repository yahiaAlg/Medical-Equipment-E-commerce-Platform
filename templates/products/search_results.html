{% extends "base.html" %}
{% load static %}

{% block title %}Search Results - Fennec Med{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/searchResults.css' %}">
{% endblock %}

{% block content %}
<!-- Search Header -->
<div class="search-header">
  <div class="search-header-content">
    <h1>Search Results</h1>
    <div class="search-container">
      <form method="get" action="{% url 'products:search' %}">
        <input
          type="text"
          name="q"
          placeholder="Search medical supplies..."
          class="search-input"
          value="{{ query }}"
        />
        <button type="submit" class="search-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      </form>
    </div>
    <p class="search-info">Showing {{ total_results }} result{{ total_results|pluralize }} for "{{ query }}"</p>
  </div>
</div>

<!-- Search Results Section -->
<div class="results-section">
  <div class="results-container">
    <aside class="filters-sidebar">
      <h3>Filter Results</h3>

      <div class="filter-group">
        <h4>Category</h4>
        <div class="filter-options">
          {% for category in categories %}
          <label>
            <input type="checkbox" name="category" value="{{ category.slug }}" />
            {{ category.name }} ({{ category.products.count }})
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="filter-group">
        <h4>Price Range</h4>
        <div class="filter-options">
          <label><input type="checkbox" name="price" value="0-50" /> Under $50</label>
          <label><input type="checkbox" name="price" value="50-200" /> $50 - $200</label>
          <label><input type="checkbox" name="price" value="200+" /> Over $200</label>
        </div>
      </div>

      <div class="filter-group">
        <h4>Brand</h4>
        <div class="filter-options">
          {% for brand in brands %}
          <label>
            <input type="checkbox" name="brand" value="{{ brand.id }}" />
            {{ brand.name }}
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="filter-group">
        <h4>Availability</h4>
        <div class="filter-options">
          <label><input type="checkbox" name="availability" value="in_stock" /> In Stock</label>
          <label><input type="checkbox" name="availability" value="pre_order" /> Pre-order</label>
        </div>
      </div>

      <button class="clear-filters-btn" onclick="window.location.href='{% url 'products:search' %}?q={{ query }}'">Clear All Filters</button>
    </aside>

    <div class="results-content">
      <div class="results-header">
        <div class="results-count">
          <span>{{ page_obj.paginator.count }} Products Found</span>
        </div>
        <div class="sort-options">
          <label for="sort">Sort by:</label>
          <select id="sort" class="sort-select" onchange="window.location.href='?q={{ query }}&sort=' + this.value">
            <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Relevance</option>
            <option value="price_low" {% if current_filters.sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
            <option value="price_high" {% if current_filters.sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
            <option value="rating" {% if current_filters.sort == 'rating' %}selected{% endif %}>Customer Rating</option>
            <option value="newest" {% if current_filters.sort == 'newest' %}selected{% endif %}>Newest First</option>
          </select>
        </div>
      </div>

      <div class="products-grid">
        {% for product in page_obj %}
        <div class="product-card">
          <div class="product-image">
            {% if product.images.first %}
            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" />
            {% else %}
            <img src="{% static 'images/placeholder.png' %}" alt="{{ product.name }}" />
            {% endif %}
            {% if product.featured %}
            <div class="product-badge">Best Seller</div>
            {% elif product.trending %}
            <div class="product-badge">Trending</div>
            {% endif %}
          </div>
          <div class="product-info">
            <h3><a href="{% url 'products:detail' product.slug %}">{{ product.name }}</a></h3>
            <p class="product-category">{{ product.category.name }}</p>
            <div class="product-rating">
              <span class="stars">★★★★★</span>
              <span class="rating-text">({{ product.get_average_rating|floatformat:1 }}) {{ product.get_review_count }} reviews</span>
            </div>
            <p class="product-description">{{ product.short_description|truncatewords:15 }}</p>
            <div class="product-price">
              <span class="current-price">${{ product.price }}</span>
              {% if product.bulk_price %}
              <span class="original-price">${{ product.bulk_price }}</span>
              {% endif %}
            </div>
            <div class="product-actions">
              <button class="add-to-cart-btn">Add to Cart</button>
              <button class="save-btn" onclick="toggleWishlist({{ product.id }})">♡</button>
            </div>
          </div>
        </div>
        {% empty %}
        <p>No products found matching your search.</p>
        {% endfor %}
      </div>

      {% if page_obj.has_other_pages %}
      <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?q={{ query }}&page={{ page_obj.previous_page_number }}" class="page-btn prev">Previous</a>
        {% else %}
        <button class="page-btn prev" disabled>Previous</button>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        <a href="?q={{ query }}&page={{ num }}" class="page-btn {% if page_obj.number == num %}active{% endif %}">{{ num }}</a>
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?q={{ query }}&page={{ page_obj.next_page_number }}" class="page-btn next">Next</a>
        {% else %}
        <button class="page-btn next" disabled>Next</button>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}