{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ product.name }} - Fennec Med{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/detail.css' %}">
{% endblock %}

{% block content %}
<div class="product-container">
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="{% url 'pages:index' %}">Home</a> ‚Ä∫
    <a href="{% url 'products:list' %}">Products</a> ‚Ä∫
    {% for category in product.categories.all %}
      <a href="{% url 'products:list' %}?category={{ category.slug }}">{{ category.name }}</a>
      {% if not forloop.last %}|{% endif %}
    {% endfor %}
    ‚Ä∫
    <span>{{ product.name|truncatewords:5 }}</span>
  </nav>

  <!-- Product Main -->
  <div class="product-main">
    <!-- Gallery -->
    <div class="product-gallery">
      <div class="main-image">
        {% if product.images.first %}
        <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" id="mainImage" />
        {% else %}
        <img src="{% static 'images/placeholder.png' %}" alt="{{ product.name }}" id="mainImage" />
        {% endif %}
      </div>

      {% if product.images.count > 1 %}
      <div class="thumbnail-images">
        {% for img in product.images.all %}
        <img src="{{ img.image.url }}" class="thumbnail {% if forloop.first %}active{% endif %}" onclick="changeImage('{{ img.image.url }}')" />
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Info -->
    <div class="product-info">
      <p class="product-brand">Brand: {{ product.brand.name }}</p>
      <h1 class="product-title">{{ product.name }}</h1>

      <div class="product-rating">
        <span class="stars">{% for i in "12345" %}{% if forloop.counter <= product.get_average_rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</span>
        <span class="rating-text">{{ product.get_average_rating|floatformat:1 }} ({{ product.get_review_count }} reviews)</span>
      </div>

      <div class="price-section">
        <span class="current-price" id="displayPrice">${{ product.price }}</span>
        {% if product.bulk_price %}
        <span class="original-price">${{ product.bulk_price }}</span>
        <span class="discount-badge">17% OFF</span>
        {% endif %}
      </div>

      <p class="unit-info">Unit: 2 lbs bag | Price per lb: $2.5</p>

      <div class="stock-status {% if product.availability_status != 'in_stock' %}out{% endif %}">
        ‚úì {{ product.get_availability_status_display }}
        {% if product.stock_quantity %}- {{ product.stock_quantity }} units{% endif %}
      </div>

      <div class="key-features">
        <h4>Key Features</h4>
        <ul>
          <li>{{ product.brand.name }} Certified</li>
          <li>High Quality Product</li>
          <li>Perfect for {{ product.category.name }}</li>
          {% if product.warranty %}<li>{{ product.warranty }} Warranty</li>{% endif %}
        </ul>
      </div>

      <div class="product-meta">
        <div class="meta-item">
          <strong>SKU:</strong>
          <span>{{ product.sku }}</span>
        </div>
        <div class="meta-item">
          <strong>Categories:</strong>
          <span>
            {% for category in product.categories.all %}
              {{ category.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </span>
        </div>
      </div>

      <!-- Variants Section -->
      {% if variants %}
      <div class="size-selector">
        <h4>Available Options:</h4>
        {% regroup variants by variant_title as variant_groups %}
        {% for group in variant_groups %}
          <div class="mb-3">
            <label class="form-label fw-bold">{{ group.grouper }}:</label>
            <div class="size-options">
              {% for variant in group.list %}
              <button class="size-btn" data-variant-id="{{ variant.id }}" data-price="{{ variant.additional_cost }}">
                {{ variant.variant_value }}
                {% if variant.additional_cost > 0 %}
                  (+${{ variant.additional_cost }})
                {% endif %}
              </button>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="quantity-cart">
        <div class="quantity-selector">
          <button class="qty-btn" onclick="changeQty(-1)">-</button>
          <input type="number" class="qty-input" id="quantity" value="1" min="1" max="{{ product.stock_quantity }}" readonly />
          <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
        <button class="btn-add-cart" onclick="addToCart({{ product.id }})">üõí Add to Cart</button>
      </div>

      <div class="action-buttons">
        <button class="btn-wishlist" onclick="toggleWishlist({{ product.id }}, this)">
          <span id="wishlist-icon-{{ product.id }}">
            {% if in_wishlist %}‚ô•{% else %}‚ô°{% endif %}
          </span>
          <span id="wishlist-text-{{ product.id }}">
            {% if in_wishlist %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}
          </span>
        </button>
      </div>

      <div class="delivery-info">
        <p>‚è± Delivery within 2-4 hours</p>
        <p>‚Ü© Easy returns within 24 hours</p>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="product-tabs">
    <div class="tab-nav">
      <button class="tab-link active" onclick="openTab(event, 'description')">üìÑ Description</button>
      <button class="tab-link" onclick="openTab(event, 'specifications')">‚öô Specifications</button>
      <button class="tab-link" onclick="openTab(event, 'reviews')">‚≠ê Reviews</button>
      <button class="tab-link" onclick="openTab(event, 'questions')">‚ùì Q&A</button>
    </div>

    <!-- Description -->
    <div id="description" class="tab-content active">
      <h3>Product Description</h3>
      {{ product.description|linebreaks }}
      {% if product.compatibility %}
      <h4>Compatibility</h4>
      {{ product.compatibility|linebreaks }}
      {% endif %}
    </div>

    <!-- Specifications -->
    <div id="specifications" class="tab-content">
      <h3>Technical Specifications</h3>
      {{ product.specifications|default:"Specifications coming soon"|linebreaks }}
    </div>

    <!-- Reviews -->
    <div id="reviews" class="tab-content">
      <div class="reviews-header">
        <h3>Customer Reviews</h3>
        {% if user.is_authenticated %}
        <button class="btn-write-review" onclick="document.getElementById('reviewForm').style.display='block'">Write a Review</button>
        {% endif %}
      </div>

      <div class="review-summary">
        <div class="rating-big">
          <div class="rating-number">{{ review_stats.avg_rating|default:0|floatformat:1 }}</div>
          <div class="stars">
            {% with avg_rating=review_stats.avg_rating|default:0 %}
              {% for i in "12345" %}
                {% if forloop.counter <= avg_rating %}‚òÖ{% else %}‚òÜ{% endif %}
              {% endfor %}
            {% endwith %}
          </div>
          <p>Based on {{ review_stats.total_count|default:0 }} review{{ review_stats.total_count|pluralize }}</p>
        </div>
        <div class="rating-bars">
          {% for star in "54321" %}
          <div class="rating-bar">
            <span class="bar-label">{{ star }} ‚òÖ</span>
            <div class="bar-container">
              <div class="bar-fill" style="width: {{ rating_percentages|get_item:star|floatformat:0 }}%"></div>
            </div>
            <span class="bar-count">{{ rating_distribution|get_item:star }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      {% if user.is_authenticated %}
      <form method="post" action="{% url 'products:add_review' %}" class="review-form" id="reviewForm" style="display:none;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="product_slug" value="{{ product.slug }}">

        <div class="form-group">
          <label>Your Rating *</label>
          <select name="rating" required>
            <option value="">Choose rating</option>
            <option value="5">5 Stars</option>
            <option value="4">4 Stars</option>
            <option value="3">3 Stars</option>
            <option value="2">2 Stars</option>
            <option value="1">1 Star</option>
          </select>
        </div>

        <div class="form-group">
          <label>Review Title *</label>
          <input type="text" name="title" placeholder="Summarize your review" required>
        </div>

        <div class="form-group">
          <label>Your Review *</label>
          <textarea name="comment" placeholder="Share details of your experience" required></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="document.getElementById('reviewForm').style.display='none'">Cancel</button>
          <button type="submit" class="btn-submit">Submit Review</button>
        </div>
      </form>
      {% endif %}

      {% for review in reviews %}
      <div class="review-item">
        <div class="review-header">
          <div class="reviewer-info">
            <div class="reviewer-avatar">{{ review.user.username|first|upper }}</div>
            <div>
              <div class="reviewer-name">{{ review.user.username }}</div>
              <div class="stars">{% for i in "12345" %}{% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</div>
              <div class="review-date">{{ review.created_at|date:"M d, Y" }}</div>
            </div>
          </div>
          {% if review.verified_purchase %}
          <span class="verified-badge">‚úì Verified Purchase</span>
          {% endif %}
        </div>
        <h4 class="review-title">{{ review.title }}</h4>
        <p class="review-text">{{ review.comment }}</p>
        <div class="review-actions">
          <span class="review-action">üëç Helpful (12)</span>
          <span class="review-action">Report</span>
        </div>
      </div>
      {% endfor %}

      {% if reviews.count > 5 %}
      <div class="show-more">
        <button class="btn-show-more">Show All {{ reviews.count }} Reviews</button>
      </div>
      {% endif %}
    </div>

    <!-- Q&A -->
    <div id="questions" class="tab-content">
      <div class="reviews-header">
        <h3>Product Questions</h3>
        {% if user.is_authenticated %}
        <button class="btn-write-review" onclick="document.getElementById('questionForm').style.display='block'">Ask a Question</button>
        {% endif %}
      </div>

      {% if user.is_authenticated %}
      <form method="post" action="{% url 'products:ask_question' %}" class="review-form" id="questionForm" style="display:none;">
        {% csrf_token %}
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="product_slug" value="{{ product.slug }}">

        <div class="form-group">
          <label>Your Question *</label>
          <textarea name="question" placeholder="Ask a question about this product..." required></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="document.getElementById('questionForm').style.display='none'">Cancel</button>
          <button type="submit" class="btn-submit">Submit Question</button>
        </div>
      </form>
      {% endif %}

      {% for question in questions %}
      <div class="review-item">
        <p><strong>Q:</strong> {{ question.question }}</p>
        <small>Asked by {{ question.user.username }} - {{ question.created_at|date:"M d, Y" }}</small>
        {% if question.answer %}
        <p style="margin-top:1rem;"><strong>A:</strong> {{ question.answer }}</p>
        {% else %}
        <p style="color:#999;margin-top:0.5rem;">Awaiting answer</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Related Products -->
  {% if related_products %}
  <div class="related-products">
    <h2>
      Related Products
      <a href="{% url 'products:list' %}?category={{ product.category.slug }}" class="view-all">View All ‚Üí</a>
    </h2>
    <div class="products-grid">
      {% for related in related_products %}
      <div class="product-card">
          {% comment %} Image Part {% endcomment %}
          <div class="product-card-image">
            <a href="{% url 'products:detail' slug=related.slug %}">
              {% if related.images.first %}
              <img src="{{ related.images.first.image.url }}" alt="{{ related.name }}" />
              {% else %}
              <img src="{% static 'images/placeholder.png' %}" alt="{{ related.name }}" />
              {% endif %}
            </a>
            <div class="discount-badge">{{related.brand.name}}</div>
            <div class="wishlist-icon" onclick="toggleWishlist({{ related.id }}, this)">
              <span id="wishlist-icon-{{ related.id }}">
                {% if related.id in wishlist_product_ids %}‚ô•{% else %}‚ô°{% endif %}
              </span>
            </div>
          </div>

          {% comment %} Content part {% endcomment %}
          <div class="product-card-body">
            <h3 class="product-card-title">
              <a href="{% url 'products:detail' slug=related.slug %}">{{ related.name|truncatewords:5 }}</a>
            </h3>
            <p class="product-card-meta">{{ related.category.name }}</p>
            <div class="product-card-rating">
              <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
              <span>({{ related.get_review_count }})</span>
            </div>
            <div class="product-card-price">
              <span class="price">${{ related.price }}</span>
              <span class="old-price">$6.99</span>
            </div>
            <button class="btn-add" onclick="event.preventDefault(); quickAddToCart({{ related.id }})">+ Add</button>
          </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
  <script>
    const basePrice = {{ product.price }};
    let selectedVariantId = null;

    function changeImage(src) {
      document.getElementById('mainImage').src = src;
      document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
    }

    function changeQty(delta) {
      const input = document.getElementById('quantity');
      const newVal = parseInt(input.value) + delta;
      if (newVal >= 1 && newVal <= parseInt(input.max)) {
        input.value = newVal;
      }
    }

    function openTab(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }

    function toggleWishlist(productId, button) {
      {% if user.is_authenticated %}
      fetch("{% url 'products:toggle_wishlist' %}", {
        method: "POST",
        headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
        body: JSON.stringify({product_id: productId})
      })
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          const icon = document.getElementById(`wishlist-icon-${productId}`);
          const text = document.getElementById(`wishlist-text-${productId}`);

          if(data.in_wishlist) {
            icon.textContent = '‚ô•';
            if(text) text.textContent = 'Remove from Wishlist';
            button.style.color = '#dc3545';
          } else {
            icon.textContent = '‚ô°';
            if(text) text.textContent = 'Add to Wishlist';
            button.style.color = '#666';
          }
        }
      });
      {% else %}
      window.location.href = "{% url 'accounts:login' %}";
      {% endif %}
    }

    // Variant selection
    document.querySelectorAll('.size-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        selectedVariantId = this.dataset.variantId;

        // Update price display
        const additionalCost = parseFloat(this.dataset.price);
        const totalPrice = basePrice + additionalCost;
        document.getElementById('displayPrice').textContent = '$' + totalPrice.toFixed(2);
      });
    });

    function addToCart(productId) {
      const quantity = document.getElementById('quantity').value;

      {% if user.is_authenticated %}
      fetch("{% url 'payments:add_to_cart' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          product_id: productId,
          variant_id: selectedVariantId,
          quantity: parseInt(quantity)
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Added to cart!');
          window.location.href = "{% url 'payments:cart' %}";
        } else {
          alert(data.message || 'Error adding to cart');
        }
      })
      .catch(err => alert('Error: ' + err));
      {% else %}
      window.location.href = "{% url 'accounts:login' %}";
      {% endif %}
    }

    function quickAddToCart(productId) {
      {% if user.is_authenticated %}
      fetch("{% url 'payments:add_to_cart' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          product_id: productId,
          variant_id: null,
          quantity: 1
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Added to cart!');
        } else {
          alert(data.message || 'Error adding to cart');
        }
      });
      {% else %}
      window.location.href = "{% url 'accounts:login' %}";
      {% endif %}
    }
  </script>
{% endblock %}
