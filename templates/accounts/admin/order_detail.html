{% extends 'base.html' %}
{% load static %}

{% block title %}Commande {{ order.order_id }} - Admin{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/admin/order_detail.css' %}">
{% endblock %}

{% block content %}
<div class="admin-header">
  <div class="container">
    <h1><i class="fas fa-file-invoice me-2"></i>Détails de la commande : {{ order.order_id }}</h1>
    <p class="mb-0">Informations complètes sur la commande et gestion</p>
  </div>
</div>

<div class="order-detail-container">
  <div class="mb-3">
    <a href="{% url 'accounts:admin_orders_management' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Retour aux commandes
    </a>
  </div>

  <!-- Order Status & Actions -->
  <div class="detail-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3><i class="fas fa-info-circle me-2"></i>Statut de la commande</h3>
      <span class="status-badge status-{{ order.status }}">
        {{ order.get_status_display }}
      </span>
    </div>

    {% if order.status == 'pending_confirmation' %}
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Cette commande est en attente de confirmation. Veuillez l'examiner et la confirmer ou la rejeter.
    </div>
    <div class="action-buttons">
      <a href="{% url 'accounts:admin_confirm_order' order.order_id %}" class="btn btn-confirm">
        <i class="fas fa-check me-2"></i>Confirmer/Rejeter la commande
      </a>
    </div>
    {% elif order.status == 'rejected' %}
    <div class="alert alert-danger">
      <i class="fas fa-times-circle me-2"></i>
      Cette commande a été rejetée le {{ order.rejected_at|date:"d M Y H:i" }}
    </div>
    {% else %}
    <div class="alert alert-success">
      <i class="fas fa-check-circle me-2"></i>
      Commande confirmée le {{ order.confirmed_at|date:"d M Y H:i" }}
    </div>
    {% endif %}
  </div>

  <!-- Customer Information -->
  <div class="detail-card">
    <h3><i class="fas fa-user me-2"></i>Informations client</h3>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Client</div>
        <div class="info-value">{{ order.user.get_full_name|default:order.user.username }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Email</div>
        <div class="info-value">{{ order.user.email }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Date de commande</div>
        <div class="info-value">{{ order.created_at|date:"d M Y H:i" }}</div>
      </div>
    </div>
  </div>

  <!-- Shipping Information -->
  <div class="detail-card">
    <h3><i class="fas fa-shipping-fast me-2"></i>Informations de livraison</h3>
    <div class="info-grid">
      {% if order.shipping_type %}
      <div class="info-item">
        <div class="info-label">Type de livraison</div>
        <div class="info-value">{{ order.shipping_type.name }}</div>
      </div>
      {% endif %}
      <div class="info-item">
        <div class="info-label">Adresse</div>
        <div class="info-value">{{ order.shipping_address }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Ville</div>
        <div class="info-value">{{ order.shipping_city }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Wilaya</div>
        <div class="info-value">{{ order.shipping_state }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Code postal</div>
        <div class="info-value">{{ order.shipping_zip }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Pays</div>
        <div class="info-value">{{ order.shipping_country }}</div>
      </div>
    </div>
  </div>

  <!-- Order Items -->
  <div class="detail-card">
    <h3><i class="fas fa-box me-2"></i>Articles de la commande</h3>
    <table class="items-table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Quantité</th>
          <th>Prix</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.product.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.price }} DZD</td>
          <td><strong>{{ item.get_total_price }} DZD</strong></td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>Sous-total</strong></td>
          <td><strong>{{ order.subtotal }} DZD</strong></td>
        </tr>
        <tr>
          <td colspan="3">Taxe ({% widthratio tva_rate 1 100 as tax_percentage %}{{ tax_percentage|floatformat:0 }}%)</td>
          <td>{{ order.tax_amount }} DZD</td>
        </tr>
        <tr>
          <td colspan="3">Livraison</td>
          <td>{{ order.shipping_cost }} DZD</td>
        </tr>
        <tr class="table-primary">
          <td colspan="3"><strong>Total</strong></td>
          <td><strong>{{ order.total_amount }} DZD</strong></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Customer Notes & Attachments -->
  {% if order_note %}
  <div class="detail-card">
    <h3><i class="fas fa-comment me-2"></i>
      {% if order_note.created_by == order.user %}
        Notes du client
      {% else %}
        Notes de la commande
      {% endif %}
    </h3>
    <div class="note-content">{{ order_note.content }}</div>
    <p class="text-muted mt-2 mb-0">
      <small>
        {% if order_note.created_by == order.user %}
          Ajoutée par le client le {{ order_note.created_at|date:"d M Y H:i" }}
        {% else %}
          Ajoutée par {{ order_note.created_by.get_full_name|default:order_note.created_by.username }} le {{ order_note.created_at|date:"d M Y H:i" }}
        {% endif %}
      </small>
    </p>
    
    {% if order_note.attachments.exists %}
    <hr>
    <h5 class="mt-3">
      {% if order_note.created_by == order.user %}
        Pièces jointes du client
      {% else %}
        Pièces jointes
      {% endif %}
    </h5>
    <ul class="attachments-list">
      {% for attachment in order_note.attachments.all %}
      <li class="attachment-item">
        <i class="fas fa-file"></i>
        <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file_name }}</a>
        <small class="text-muted ms-2">({{ attachment.uploaded_at|date:"d M Y" }})</small>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}