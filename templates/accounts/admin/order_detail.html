{% extends 'base.html' %}
{% load static %}

{% block title %}Order {{ order.order_id }} - Admin{% endblock %}

{% block extra_css %}
<style>
.admin-header {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
  color: white;
  padding: 2rem 0;
  margin-bottom: 2rem;
}

.order-detail-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.detail-card {
  background: white;
  border-radius: 10px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
}

.detail-card h3 {
  color: var(--brand-blue);
  margin-bottom: 1rem;
  font-size: 1.25rem;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.info-item {
  padding: 0.75rem;
  background: #f8f9fa;
  border-radius: 5px;
}

.info-label {
  font-size: 0.875rem;
  color: #666;
  margin-bottom: 0.25rem;
}

.info-value {
  font-weight: 600;
  color: #333;
}

.status-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  white-space: nowrap;
}

.status-pending_confirmation { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d4edda; color: #155724; }
.status-rejected { background: #f8d7da; color: #721c24; }
.status-awaiting_payment { background: #fff3cd; color: #856404; }

.items-table {
  width: 100%;
  border-collapse: collapse;
}

.items-table th, .items-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}

.items-table th {
  background: #f8f9fa;
  font-weight: 600;
}

.note-content {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 5px;
  border-left: 4px solid var(--accent-blue);
  white-space: pre-wrap;
}

.attachments-list {
  list-style: none;
  padding: 0;
}

.attachment-item {
  display: flex;
  align-items: center;
  padding: 0.75rem;
  background: #f8f9fa;
  border-radius: 5px;
  margin-bottom: 0.5rem;
}

.attachment-item i {
  color: var(--primary-blue);
  margin-right: 0.5rem;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.btn-confirm {
  background-color: #28a745;
  color: white;
}

.btn-confirm:hover {
  background-color: #218838;
  color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
  <div class="container">
    <h1><i class="fas fa-file-invoice me-2"></i>Order Details: {{ order.order_id }}</h1>
    <p class="mb-0">Complete order information and management</p>
  </div>
</div>

<div class="order-detail-container">
  <div class="mb-3">
    <a href="{% url 'accounts:admin_orders_management' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Orders
    </a>
  </div>

  <!-- Order Status & Actions -->
  <div class="detail-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3><i class="fas fa-info-circle me-2"></i>Order Status</h3>
      <span class="status-badge status-{{ order.status }}">
        {{ order.get_status_display }}
      </span>
    </div>

    {% if order.status == 'pending_confirmation' %}
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      This order is awaiting confirmation. Please review and confirm or reject.
    </div>
    <div class="action-buttons">
      <a href="{% url 'accounts:admin_confirm_order' order.order_id %}" class="btn btn-confirm">
        <i class="fas fa-check me-2"></i>Confirm/Reject Order
      </a>
    </div>
    {% elif order.status == 'rejected' %}
    <div class="alert alert-danger">
      <i class="fas fa-times-circle me-2"></i>
      This order was rejected on {{ order.rejected_at|date:"M d, Y H:i" }}
    </div>
    {% else %}
    <div class="alert alert-success">
      <i class="fas fa-check-circle me-2"></i>
      Order confirmed on {{ order.confirmed_at|date:"M d, Y H:i" }}
    </div>
    {% endif %}
  </div>

  <!-- Customer Information -->
  <div class="detail-card">
    <h3><i class="fas fa-user me-2"></i>Customer Information</h3>
    <div class="info-grid">
      <div class="info-item">
        <div class="info-label">Customer</div>
        <div class="info-value">{{ order.user.get_full_name|default:order.user.username }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Email</div>
        <div class="info-value">{{ order.user.email }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Order Date</div>
        <div class="info-value">{{ order.created_at|date:"M d, Y H:i" }}</div>
      </div>
    </div>
  </div>

  <!-- Shipping Information -->
  <div class="detail-card">
    <h3><i class="fas fa-shipping-fast me-2"></i>Shipping Information</h3>
    <div class="info-grid">
      {% if order.shipping_type %}
      <div class="info-item">
        <div class="info-label">Shipping Type</div>
        <div class="info-value">{{ order.shipping_type.name }}</div>
      </div>
      {% endif %}
      <div class="info-item">
        <div class="info-label">Address</div>
        <div class="info-value">{{ order.shipping_address }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">City</div>
        <div class="info-value">{{ order.shipping_city }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">State</div>
        <div class="info-value">{{ order.shipping_state }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ZIP Code</div>
        <div class="info-value">{{ order.shipping_zip }}</div>
      </div>
      <div class="info-item">
        <div class="info-label">Country</div>
        <div class="info-value">{{ order.shipping_country }}</div>
      </div>
    </div>
  </div>

  <!-- Order Items -->
  <div class="detail-card">
    <h3><i class="fas fa-box me-2"></i>Order Items</h3>
    <table class="items-table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>{{ item.product.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.price }} DZD</td>
          <td><strong>{{ item.get_total_price }} DZD</strong></td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>Subtotal</strong></td>
          <td><strong>{{ order.subtotal }} DZD</strong></td>
        </tr>
        <tr>
          <td colspan="3">Tax (19%)</td>
          <td>{{ order.tax_amount }} DZD</td>
        </tr>
        <tr>
          <td colspan="3">Shipping</td>
          <td>{{ order.shipping_cost }} DZD</td>
        </tr>
        <tr class="table-primary">
          <td colspan="3"><strong>Total</strong></td>
          <td><strong>{{ order.total_amount }} DZD</strong></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Customer Notes & Attachments -->
  {% if order_note %}
  <div class="detail-card">
    <h3><i class="fas fa-comment me-2"></i>
      {% if order_note.created_by == order.user %}
        Customer Notes
      {% else %}
        Order Notes
      {% endif %}
    </h3>
    <div class="note-content">{{ order_note.content }}</div>
    <p class="text-muted mt-2 mb-0">
      <small>
        {% if order_note.created_by == order.user %}
          Added by customer on {{ order_note.created_at|date:"M d, Y H:i" }}
        {% else %}
          Added by {{ order_note.created_by.get_full_name|default:order_note.created_by.username }} on {{ order_note.created_at|date:"M d, Y H:i" }}
        {% endif %}
      </small>
    </p>
    
    {% if order_note.attachments.exists %}
    <hr>
    <h5 class="mt-3">
      {% if order_note.created_by == order.user %}
        Customer Attachments
      {% else %}
        Attachments
      {% endif %}
    </h5>
    <ul class="attachments-list">
      {% for attachment in order_note.attachments.all %}
      <li class="attachment-item">
        <i class="fas fa-file"></i>
        <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file_name }}</a>
        <small class="text-muted ms-2">({{ attachment.uploaded_at|date:"M d, Y" }})</small>
      </li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}