{% extends 'base.html' %}
{% load static %}

{% block title %}Rapports et analyses - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin/reports.css' %}">
{% endblock %}

{% block content %}
<div class="admin-header">
  <div class="container">
    <h1><i class="fas fa-chart-bar me-2"></i>Rapports et analyses</h1>
    <p class="mb-0">Statistiques commerciales complètes et indicateurs de performance</p>
  </div>
</div>

<div class="container mb-5">
  <div class="mb-3">
    <a href="{% url 'accounts:admin_dashboard' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
    </a>
  </div>

  <!-- Period Filter -->
  <div class="filter-bar">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Période</label>
        <select name="period" class="form-select" onchange="this.form.submit()">
          <option value="7" {% if period == '7' %}selected{% endif %}>7 derniers jours</option>
          <option value="30" {% if period == '30' %}selected{% endif %}>30 derniers jours</option>
          <option value="90" {% if period == '90' %}selected{% endif %}>90 derniers jours</option>
          <option value="180" {% if period == '180' %}selected{% endif %}>6 derniers mois</option>
          <option value="365" {% if period == '365' %}selected{% endif %}>Dernière année</option>
        </select>
      </div>
      <div class="col-md-9 text-end">
        <small class="text-muted">
          <i class="fas fa-calendar-alt me-1"></i>
          {{ start_date|date:"d M Y" }} - {{ end_date|date:"d M Y" }}
        </small>
      </div>
    </form>
  </div>

  <!-- Section Tabs -->
  <ul class="nav section-tabs" id="reportTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#financial">
        <i class="fas fa-dollar-sign me-2"></i>Financier
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#products">
        <i class="fas fa-box me-2"></i>Produits
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#customers">
        <i class="fas fa-users me-2"></i>Clients
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#reviews">
        <i class="fas fa-star me-2"></i>Avis
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#support">
        <i class="fas fa-headset me-2"></i>Support
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- FINANCIAL TAB -->
    <div class="tab-pane fade show active" id="financial">
      <!-- Key Financial Metrics -->
      <div class="metric-grid">
        <div class="metric-box success">
          <div class="stat-icon green">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="label">Revenu total</div>
          <div class="value">{{ total_revenue|floatformat:2 }} DZD</div>
        </div>
        <div class="metric-box info">
          <div class="stat-icon blue">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="label">Revenu net</div>
          <div class="value">{{ net_revenue|floatformat:2 }} DZD</div>
          <div class="subvalue">Après remboursements</div>
        </div>
        <div class="metric-box">
          <div class="stat-icon orange">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="label">Total commandes</div>
          <div class="value">{{ order_stats.total_orders }}</div>
        </div>
        <div class="metric-box">
          <div class="stat-icon blue">
            <i class="fas fa-receipt"></i>
          </div>
          <div class="label">Valeur moy. commande</div>
          <div class="value">{{ avg_order_value|floatformat:2 }} DZD</div>
          <div class="subvalue">{{ avg_items_per_order|floatformat:1 }} articles/commande</div>
        </div>
        <div class="metric-box danger">
          <div class="stat-icon red">
            <i class="fas fa-undo"></i>
          </div>
          <div class="label">Total remboursé</div>
          <div class="value">{{ total_refunded|floatformat:2 }} DZD</div>
        </div>
      </div>

      <div class="row">
        <!-- Daily Revenue Chart -->
        <div class="col-lg-8 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-chart-area me-2"></i>Tendance du revenu</h5>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Revenue by Status -->
        <div class="col-lg-4 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-chart-pie me-2"></i>Revenu par statut</h5>
            <div class="chart-container small">
              <canvas id="revenueStatusChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-credit-card me-2"></i>Méthodes de paiement</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Méthode</th>
                  <th class="text-center">Nombre</th>
                  <th class="text-end">Montant total</th>
                </tr>
              </thead>
              <tbody>
                {% for method in payment_methods %}
                <tr>
                  <td><span class="badge bg-primary">{{ method.payment_method|title }}</span></td>
                  <td class="text-center">{{ method.count }}</td>
                  <td class="text-end fw-bold">{{ method.total_amount|floatformat:2 }} DZD</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Order Status Breakdown -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-shopping-bag me-2"></i>Statut des commandes</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Statut</th>
                  <th class="text-end">Nombre</th>
                </tr>
              </thead>
              <tbody>
                {% for status in order_stats.by_status %}
                <tr>
                  <td>{{ status.status|title }}</td>
                  <td class="text-end"><strong>{{ status.count }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUCTS TAB -->
    <div class="tab-pane fade" id="products">
      <div class="metric-grid">
        <div class="metric-box warning">
          <div class="stat-icon orange">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="label">Articles en rupture partielle</div>
          <div class="value">{{ low_stock_products|length }}</div>
        </div>
        <div class="metric-box danger">
          <div class="stat-icon red">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="label">Rupture de stock</div>
          <div class="value">{{ out_of_stock_count }}</div>
        </div>
      </div>

      <div class="row">
        <!-- Top Products -->
        <div class="col-lg-8 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-trophy me-2"></i>Produits les plus vendus</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Produit</th>
                  <th>Catégorie</th>
                  <th class="text-center">Qté vendue</th>
                  <th class="text-end">Revenu</th>
                </tr>
              </thead>
              <tbody>
                {% for product in top_products %}
                <tr>
                  <td><span class="badge badge-custom bg-primary">#{{ forloop.counter }}</span></td>
                  <td class="fw-medium">{{ product.product__name|truncatewords:5 }}</td>
                  <td><small class="text-muted">{{ product.categories|default:"N/A" }}</small></td>                  <td class="text-center"><strong>{{ product.total_quantity }}</strong></td>
                  <td class="text-end text-success fw-bold">{{ product.total_revenue|floatformat:2 }} DZD</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Low Stock Alert -->
        <div class="col-lg-4 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-warehouse me-2"></i>Alerte stock faible</h5>
            <div style="max-height: 400px; overflow-y: auto;">
              {% for product in low_stock_products %}
              <div class="mb-3 p-2 border-start border-warning border-3 bg-light">
                <div class="fw-medium">{{ product.name|truncatewords:4 }}</div>
                <div class="text-danger small">Stock : {{ product.stock_quantity }} unités</div>
              </div>
              {% empty %}
              <p class="text-muted text-center py-3">Aucun article en stock faible</p>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Category Performance -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-layer-group me-2"></i>Performance par catégorie</h5>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Specialty Performance -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-stethoscope me-2"></i>Performance par spécialité</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Spécialité</th>
                  <th class="text-center">Commandes</th>
                  <th class="text-end">Revenu</th>
                </tr>
              </thead>
              <tbody>
                {% for specialty in specialty_performance %}
                <tr>
                  <td>{{ specialty.product__specialty|title }}</td>
                  <td class="text-center">{{ specialty.total_orders }}</td>
                  <td class="text-end fw-bold">{{ specialty.total_revenue|floatformat:2 }} DZD</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOMERS TAB -->
    <div class="tab-pane fade" id="customers">
      <div class="metric-grid">
        <div class="metric-box">
          <div class="stat-icon blue">
            <i class="fas fa-users"></i>
          </div>
          <div class="label">Total utilisateurs</div>
          <div class="value">{{ total_users }}</div>
        </div>
        <div class="metric-box success">
          <div class="stat-icon green">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="label">Clients actifs</div>
          <div class="value">{{ active_users }}</div>
          <div class="subvalue">Ont passé commande dans la période</div>
        </div>
      </div>

      <div class="row">
        <!-- User Registration Trend -->
        <div class="col-lg-8 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-user-plus me-2"></i>Tendance des inscriptions</h5>
            <div class="chart-container">
              <canvas id="registrationChart"></canvas>
            </div>
          </div>
        </div>

        <!-- User Type Distribution -->
        <div class="col-lg-4 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-user-tag me-2"></i>Types d'utilisateurs</h5>
            <div class="chart-container small">
              <canvas id="userTypeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Top Customers -->
        <div class="col-12 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-crown me-2"></i>Meilleurs clients par valeur totale</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Client</th>
                  <th>Email</th>
                  <th class="text-center">Commandes</th>
                  <th class="text-end">Total dépensé</th>
                </tr>
              </thead>
              <tbody>
                {% for customer in top_customers %}
                <tr>
                  <td><span class="badge badge-custom bg-warning text-dark">#{{ forloop.counter }}</span></td>
                  <td class="fw-medium">{{ customer.user__username }}</td>
                  <td><small class="text-muted">{{ customer.user__email }}</small></td>
                  <td class="text-center">{{ customer.order_count }}</td>
                  <td class="text-end text-success fw-bold">{{ customer.total_spent|floatformat:2 }} DZD</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- REVIEWS TAB -->
    <div class="tab-pane fade" id="reviews">
      <div class="row">
        <!-- Rating Distribution -->
        <div class="col-lg-4 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-star-half-alt me-2"></i>Répartition des notes</h5>
            <div class="chart-container small">
              <canvas id="ratingDistChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Review Trend -->
        <div class="col-lg-8 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-chart-line me-2"></i>Volume d'avis et note moyenne</h5>
            <div class="chart-container">
              <canvas id="reviewTrendChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Ratings by Category -->
        <div class="col-12 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-layer-group me-2"></i>Notes moyennes par catégorie</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Catégorie</th>
                  <th class="text-center">Avis</th>
                  <th class="text-center">Note moy.</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody>
                {% for rating in ratings_by_category %}
                <tr>
                  <td class="fw-medium">{{ rating.product__category__name }}</td>
                  <td class="text-center">{{ rating.review_count }}</td>
                  <td class="text-center">
                    <span class="badge bg-warning text-dark">{{ rating.avg_rating|floatformat:1 }} ★</span>
                  </td>
                  <td>
                    <div class="progress-custom">
                        <div class="progress-bar-custom" style="width: {% widthratio rating.avg_rating 5 100 %}%"></div>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">Aucun avis disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- SUPPORT TAB -->
    <div class="tab-pane fade" id="support">
      <div class="metric-grid">
        <div class="metric-box">
          <div class="stat-icon orange">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="label">Messages de contact</div>
          <div class="value">{{ contact_by_type|length }}</div>
        </div>
        <div class="metric-box warning">
          <div class="stat-icon orange">
            <i class="fas fa-clock"></i>
          </div>
          <div class="label">Paiements en attente</div>
          <div class="value">{{ payment_stats.pending_verifications }}</div>
        </div>
        <div class="metric-box info">
          <div class="stat-icon blue">
            <i class="fas fa-flag"></i>
          </div>
          <div class="label">Réclamations ouvertes</div>
          <div class="value">{{ complaint_stats.open_complaints }}</div>
        </div>
        <div class="metric-box success">
          <div class="stat-icon green">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="label">Taux de résolution</div>
          <div class="value">{{ complaint_stats.resolution_rate|floatformat:1 }}%</div>
          {% if complaint_stats.avg_resolution_time %}
          <div class="subvalue">Moy : {{ complaint_stats.avg_resolution_time|floatformat:1 }}h</div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <!-- Contact Messages by Type -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-envelope-open-text me-2"></i>Demandes de contact</h5>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th class="text-center">Total</th>
                  <th class="text-center">Répondus</th>
                  <th class="text-center">Taux</th>
                </tr>
              </thead>
              <tbody>
                {% for contact in contact_by_type %}
                <tr>
                  <td>{{ contact.inquiry_type|title }}</td>
                  <td class="text-center">{{ contact.count }}</td>
                  <td class="text-center">{{ contact.responded }}</td>
                  <td class="text-center">
                    {% widthratio contact.responded contact.count 100 as response_rate %}
                    <span class="badge {% if response_rate >= 80 %}bg-success{% elif response_rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                      {{ response_rate }}%
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">Aucune donnée disponible</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Payment Status -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-money-check-alt me-2"></i>Vérifications de paiement</h5>
            <div class="chart-container small">
              <canvas id="paymentStatusChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Complaint Statistics -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-flag me-2"></i>Statut des réclamations</h5>
            <table class="data-table">
              <tbody>
                <tr>
                  <td>Réclamations ouvertes</td>
                  <td class="text-end"><span class="badge bg-danger">{{ complaint_stats.open_complaints }}</span></td>
                </tr>
                <tr>
                  <td>En examen</td>
                  <td class="text-end"><span class="badge bg-warning">{{ complaint_stats.in_review }}</span></td>
                </tr>
                <tr>
                  <td>Résolues</td>
                  <td class="text-end"><span class="badge bg-success">{{ complaint_stats.resolved_complaints }}</span></td>
                </tr>
              </tbody>
            </table>

            {% if complaint_stats.by_reason %}
            <h6 class="mt-3 mb-2">Par motif :</h6>
            <table class="data-table">
              <tbody>
                {% for reason in complaint_stats.by_reason %}
                <tr>
                  <td>{{ reason.reason__name }}</td>
                  <td class="text-end"><strong>{{ reason.count }}</strong></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% endif %}
          </div>
        </div>

        <!-- Refund Statistics -->
        <div class="col-lg-6 mb-4">
          <div class="report-card">
            <h5><i class="fas fa-undo me-2"></i>Aperçu des remboursements</h5>
            <table class="data-table">
              <tbody>
                <tr>
                  <td>Remboursements en attente</td>
                  <td class="text-end"><span class="badge bg-warning">{{ refund_stats.pending_refunds }}</span></td>
                </tr>
                <tr>
                  <td>Remboursements finalisés</td>
                  <td class="text-end"><span class="badge bg-success">{{ refund_stats.completed_refunds }}</span></td>
                </tr>
                <tr>
                  <td>Total remboursé</td>
                  <td class="text-end"><strong class="text-danger">{{ refund_stats.total_refunded|floatformat:2 }} DZD</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Pass data to external JS file
  window.reportData = {
    dailyRevenue: {{ daily_revenue|safe }},
    revenueByStatus: {{ revenue_by_status|safe }},
    userRegistrations: {{ user_registrations|safe }},
    userTypes: {{ user_types|safe }},
    reviewTrend: {{ review_trend|safe }},
    ratingDistribution: {{ rating_distribution|safe }},
    categoryPerformance: {{ category_performance|safe }},
    paymentStats: {
      pending: {{ payment_stats.pending_verifications }},
      verified: {{ payment_stats.verified_payments }},
      rejected: {{ payment_stats.rejected_payments }}
    }
  };
</script>
<script src="{% static 'js/reports.js' %}"></script>
{% endblock %}